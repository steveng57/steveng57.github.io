{% assign templateImageFiles = site.static_files | where_exp: "item", "item.path contains 'Thumbnails'" %}
{% assign imageFiles = templateImageFiles | where_exp: "item", "item.path contains 'assets/img/posts'" %}
{% assign images_per_page = 5 %}
{% assign total_pages = imageFiles.size | divided_by: images_per_page | plus: 1 %}
{% assign lastpostname = '' %}

<!-- Pagination links (top)-->
<div id="pagination-top" data-total-pages="{{ total_pages }}">
    <a href="#" class="page-link" id="prev-page-top"><i class="fas fa-chevron-left"></i></a>
    {% for i in (1..total_pages) %}
        <a href="#" class="page-link" data-page="{{ i }}">{{ i }}</a>
    {% endfor %}
    <a href="#" class="page-link" id="next-page-top"><i class="fas fa-chevron-right"></i></a>
</div>

<div id="{{ include.albumname }}">
    {% for image in imageFiles %}
        {% assign postname = image.path | replace: '/Thumbnails', '' | replace: '/assets/img/posts', '' | replace: image.name, '' | replace: '/', '' %}
        {% assign page = forloop.index | divided_by: images_per_page | plus: 1 %}
        
        <div class="page" data-page="{{ page }}">
            {% if lastpostname != postname %}
                <h2>{{ postname }}</h2>
                {% assign lastpostname = postname %}
            {% endif %}
            
            {% assign redirect = '/posts/' | append: postname %}
            <a href="{{ redirect }}">
                <img data-src="{{ image.path }}"  src="" title="{{ redirect }}" alt="{{ redirect }}" />
            </a>
            <br><br>
        </div>
    {% endfor %}
</div>

<!-- Pagination links (bottom)-->
<div id="pagination-bottom" data-total-pages="{{ total_pages }}">
    <a href="#" class="page-link" id="prev-page-bottom"><i class="fas fa-chevron-left"></i></a>
    {% for i in (1..total_pages) %}
        <a href="#" class="page-link" data-page="{{ i }}">{{ i }}</a>
    {% endfor %}
    <a href="#" class="page-link" id="next-page-bottom"><i class="fas fa-chevron-right"></i></a>
</div>

<style>
    #pagination-top, #pagination-bottom {
        display: flex;
        justify-content: center;
        gap: 10px;
    }

    .current-page {
        font-weight: bold;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    var currentPage = 1;
    var pages = document.querySelectorAll('.page');
    var links = document.querySelectorAll('.page-link');
    var prevPageLinks = document.querySelectorAll('#prev-page-top, #prev-page-bottom');
    var nextPageLinks = document.querySelectorAll('#next-page-top, #next-page-bottom');
    var total_pages = parseInt(document.querySelector('#pagination-top').getAttribute('data-total-pages'));

    var images = document.querySelectorAll('img[data-src]');
    var config = {
        rootMargin: '0px 0px 50px 0px',
        threshold: 0
    };

    var imageObserver = new IntersectionObserver(function(entries, self) {
        entries.forEach(function(entry) {
            if (entry.isIntersecting) {
                preloadImage(entry.target);
                self.unobserve(entry.target);
            }
        });
    }, config);

    images.forEach(function(image) {
        imageObserver.observe(image);
    });

    function preloadImage(img) {
        const src = img.getAttribute('data-src');
        if (!src) {
            return;
        }
        img.src = src;
    }

    function showPage(page) {
        pages.forEach(function(pageDiv) {
            pageDiv.style.display = pageDiv.getAttribute('data-page') == page ? 'block' : 'none';
        });
        currentPage = page;
        prevPageLinks.forEach(function(link) {
            link.style.visibility = currentPage == 1 ? 'hidden' : 'visible';
        });
        nextPageLinks.forEach(function(link) {
            link.style.visibility = currentPage == total_pages ? 'hidden' : 'visible';
        });

        // Remove the current-page class from all links
        links.forEach(function(link) {
            link.classList.remove('current-page');
        });

        // Add the current-page class to the current page link
        var currentPageLink = document.querySelector('.page-link[data-page="' + currentPage + '"]');
        if (currentPageLink) {
            currentPageLink.classList.add('current-page');
        }
    }

    links.forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            var page = parseInt(link.getAttribute('data-page')); // Convert the page attribute to a number
            if (page) {
                showPage(page);
            }
        });
    });

    prevPageLinks.forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage > 1) showPage(currentPage - 1);
        });
    });

    nextPageLinks.forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage < total_pages) showPage(currentPage + 1);
        });
    });
    showPage(currentPage);
});
</script>
